// File Path: prisma/schema.prisma

// --- Generator & Datasource ---

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}


// --- Enums ---

enum ActionType {
  USER_REGISTER
  USER_LOGIN_SUCCESS
  USER_LOGIN_FAIL
  USER_LOGOUT
  FILE_UPLOAD
  FILE_DOWNLOAD
  FILE_REVOKE
  FILE_SCAN_THREAT_DETECTED
  FILE_SCAN_CLEAN
  ADMIN_USER_EDIT
  ADMIN_USER_DELETE
  ADMIN_USER_STATUS_CHANGE
  ADMIN_SHARE_REVOKE
}

enum ScanStatus {
  PENDING
  CLEAN
  THREAT_DETECTED
  ERROR
}


// --- Models ---

model User {
  id        String   @id @default(uuid())
  // NOTE: This schema uses firstName & lastName.
  // Remember to update your frontend components (Admin Dashboard, Edit Form, Header)
  // and APIs to use these fields instead of a single 'name' field.
  firstName String
  lastName  String
  email     String   @unique
  password  String
  role      String
  idNumber  String   @unique
  createdAt DateTime @default(now())
  status    String   @default("active")

  filesUploaded File[] @relation("UploadedFiles")
  filesReceived File[] @relation("ReceivedFiles")
}

// NOTE: This model is syntactically correct, but is currently not connected
// to the User model. To make it functional, you would typically add a
// foreign key field to the User model that relates back to this table's id.
model PreExistingIDs {
  id        String  @id @default(uuid())
  studentId String?
  teacherId String?
}

model File {
  id               Int      @id @default(autoincrement())
  fileName         String
  filePath         String
  mimeType         String
  size             Int
  recipientEmail   String
  iv               String
  authTag          String
  downloadToken    String?  @unique
  tokenExpiresAt   DateTime?
  createdAt        DateTime @default(now())

  // --- File Scanning Fields ---
  scanStatus       ScanStatus @default(PENDING)
  scanResult       String?    // Detailed scan results/threat information
  scannedAt        DateTime?
  scanEngine       String?    // Which engine was used (e.g., "Windows Defender", "ClamAV")

  // --- Relations ---
  uploaderId       String
  uploader         User     @relation("UploadedFiles", fields: [uploaderId], references: [id])
  recipientId      String?  // Type 'String' correctly matches User 'id'
  recipient        User?    @relation("ReceivedFiles", fields: [recipientId], references: [id])

  // --- VVV CORRECTION & SUGGESTION: Indexes ---
  // Indexes are defined at the model level for better query performance.
  // The incorrect '@index' attribute on the field line has been removed.
  @@index([recipientId]) // Speeds up fetching "Received Files" for a user.
  @@index([uploaderId])  // Speeds up fetching "Sent Files" for a user.
  @@index([scanStatus])   // Index for querying by scan status
  // --- ^^^ CORRECTION & SUGGESTION: Indexes ^^^ ---
}

model ActivityLog {
  id         Int        @id @default(autoincrement())
  createdAt  DateTime   @default(now())
  actorEmail String
  action     ActionType
  details    String?
  ipAddress  String?

  @@index([createdAt])
  @@index([actorEmail])
}
